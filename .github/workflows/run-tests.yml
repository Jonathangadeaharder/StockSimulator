name: Run Tests and Commit Results

on:
  push:
    branches:
      - '**'  # Run on all branches
  pull_request:
    branches:
      - '**'

jobs:
  test:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Need write permission to commit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for amending
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Add any dependencies if needed
          # pip install -r requirements.txt

      - name: Run tests and capture output
        run: |
          echo "================================================" > tests.log
          echo "Test Execution Log" >> tests.log
          echo "Branch: ${{ github.ref_name }}" >> tests.log
          echo "Commit: ${{ github.sha }}" >> tests.log
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> tests.log
          echo "================================================" >> tests.log
          echo "" >> tests.log

          # Run comprehensive test suite (unit + validation tests)
          if python3 tests/run_all_tests.py >> tests.log 2>&1; then
            echo "" >> tests.log
            echo "================================================" >> tests.log
            echo "✅ ALL TESTS PASSED" >> tests.log
            echo "================================================" >> tests.log
            TEST_STATUS="PASS"
          else
            echo "" >> tests.log
            echo "================================================" >> tests.log
            echo "❌ TESTS FAILED" >> tests.log
            echo "================================================" >> tests.log
            TEST_STATUS="FAIL"
          fi

          # Store status for later steps
          echo "TEST_STATUS=$TEST_STATUS" >> $GITHUB_ENV

      - name: Display test results
        run: |
          echo "Test execution completed. Results:"
          cat tests.log

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit test results (amend if push, new commit if PR)
        run: |
          # Add the test log file
          git add tests.log

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit - tests.log unchanged"
          else
            if [ "${{ github.event_name }}" == "push" ]; then
              # For push events, handle with retries to avoid race conditions
              # Only force-push if not on protected branches
              if [ "${{ github.ref_name }}" != "main" ] && [ "${{ github.ref_name }}" != "master" ]; then
                echo "Amending last commit with test results..."
                git commit --amend --no-edit
                
                # Retry logic to handle race conditions
                MAX_RETRIES=3
                RETRY_COUNT=0
                while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                  if git push --force-with-lease origin ${{ github.ref_name }}; then
                    echo "✅ Test results committed and pushed (amended)"
                    break
                  else
                    RETRY_COUNT=$((RETRY_COUNT + 1))
                    if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                      echo "⚠️ Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                      # Fetch latest changes and try to rebase
                      git fetch origin ${{ github.ref_name }}
                      # Reset to staged state and re-amend on top of latest
                      git reset --soft origin/${{ github.ref_name }}
                      git add tests.log
                      git commit --amend --no-edit || echo "Commit already exists"
                      sleep 2
                    else
                      echo "❌ Failed to push after $MAX_RETRIES attempts"
                      echo "This is likely due to concurrent pushes. Test results are still valid."
                      exit 0  # Don't fail the workflow, tests passed
                    fi
                  fi
                done
              else
                echo "⚠️ Skipping force-push to protected branch (${{ github.ref_name }})"
                echo "Creating new commit instead..."
                
                # Pull latest changes to avoid race condition
                git fetch origin ${{ github.ref_name }}
                git rebase origin/${{ github.ref_name }} || {
                  echo "Rebase failed, using merge strategy..."
                  git rebase --abort
                  git merge origin/${{ github.ref_name }} -m "Merge latest changes"
                }
                
                git commit -m "Add test execution log [skip ci]"
                
                # Retry push with latest changes
                MAX_RETRIES=3
                RETRY_COUNT=0
                while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                  if git push origin ${{ github.ref_name }}; then
                    echo "✅ Test results committed and pushed (new commit)"
                    break
                  else
                    RETRY_COUNT=$((RETRY_COUNT + 1))
                    if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                      echo "⚠️ Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                      git pull --rebase origin ${{ github.ref_name }}
                      sleep 2
                    else
                      echo "❌ Failed to push after $MAX_RETRIES attempts"
                      echo "This is likely due to concurrent pushes. Test results are still valid."
                      exit 0  # Don't fail the workflow, tests passed
                    fi
                  fi
                done
              fi
            else
              # For pull requests, create a new commit with retry logic
              echo "Creating new commit with test results..."
              
              # Fetch and rebase to get latest PR changes
              git fetch origin ${{ github.head_ref }}
              git rebase origin/${{ github.head_ref }} || {
                echo "Rebase failed, using merge strategy..."
                git rebase --abort
                git merge origin/${{ github.head_ref }} -m "Merge latest PR changes"
              }
              
              git commit -m "Add test execution log [skip ci]"
              
              # Retry push
              MAX_RETRIES=3
              RETRY_COUNT=0
              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                if git push origin HEAD:${{ github.head_ref }}; then
                  echo "✅ Test results committed and pushed (new commit)"
                  break
                else
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                  if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                    echo "⚠️ Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                    git pull --rebase origin ${{ github.head_ref }}
                    sleep 2
                  else
                    echo "❌ Failed to push after $MAX_RETRIES attempts"
                    echo "This is likely due to concurrent pushes. Test results are still valid."
                    exit 0  # Don't fail the workflow, tests passed
                  fi
                fi
              done
            fi
          fi

      - name: Fail workflow if tests failed
        if: env.TEST_STATUS == 'FAIL'
        run: |
          echo "❌ Tests failed - check tests.log for details"
          exit 1
