name: Run Tests and Commit Results

on:
  push:
    branches:
      - '**'  # Run on all branches
  pull_request:
    branches:
      - '**'

jobs:
  test:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Need write permission to commit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for amending
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Add any dependencies if needed
          # pip install -r requirements.txt

      - name: Run tests and capture output
        run: |
          echo "================================================" > tests.log
          echo "Test Execution Log" >> tests.log
          echo "Branch: ${{ github.ref_name }}" >> tests.log
          echo "Commit: ${{ github.sha }}" >> tests.log
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> tests.log
          echo "================================================" >> tests.log
          echo "" >> tests.log

          # Run tests and capture both stdout and stderr
          if python3 tests/test_analysis_suite.py >> tests.log 2>&1; then
            echo "" >> tests.log
            echo "================================================" >> tests.log
            echo "✅ ALL TESTS PASSED" >> tests.log
            echo "================================================" >> tests.log
            TEST_STATUS="PASS"
          else
            echo "" >> tests.log
            echo "================================================" >> tests.log
            echo "❌ TESTS FAILED" >> tests.log
            echo "================================================" >> tests.log
            TEST_STATUS="FAIL"
          fi

          # Store status for later steps
          echo "TEST_STATUS=$TEST_STATUS" >> $GITHUB_ENV

      - name: Display test results
        run: |
          echo "Test execution completed. Results:"
          cat tests.log

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit test results (amend if push, new commit if PR)
        run: |
          # Add the test log file
          git add tests.log

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit - tests.log unchanged"
          else
            if [ "${{ github.event_name }}" == "push" ]; then
              # For push events, amend the last commit
              echo "Amending last commit with test results..."
              git commit --amend --no-edit

              # Force push the amended commit
              git push --force-with-lease origin ${{ github.ref_name }}
              echo "✅ Test results committed and pushed (amended)"
            else
              # For pull requests, create a new commit
              echo "Creating new commit with test results..."
              git commit -m "Add test execution log [skip ci]"
              git push origin HEAD:${{ github.head_ref }}
              echo "✅ Test results committed and pushed (new commit)"
            fi
          fi

      - name: Fail workflow if tests failed
        if: env.TEST_STATUS == 'FAIL'
        run: |
          echo "❌ Tests failed - check tests.log for details"
          exit 1
